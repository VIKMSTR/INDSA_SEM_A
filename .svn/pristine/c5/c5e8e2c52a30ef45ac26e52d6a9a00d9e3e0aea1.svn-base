using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using INDSA_Sem_A.Dijkstra;
using INDSA_Sem_A.Exceptions;

namespace INDSA_Sem_A
{
    public partial class MainForm : Form
    {
        private Graph g;
      
        private List<DrawingNode> drawingNodes;

        private List<INode> shortestPath; 
        private Brush nodeBrush;
        private Brush busBrush;
        private Brush restBrush;
        private Brush edgeBrush;
        private Brush disabledBrush;
        private Brush shortestBrush;
        private Node created;
        private INode from;
        private INode to;
        private INode nearestNode;
        private bool begining;
        private bool drawShortestPath;
        private INode pathBegin;
        private INode pathEnd;
        private bool beginingPath;
        private double zoomstep;
        private Dijkstra.DijkstraAlgorithm dijkstra;

        public MainForm()
        {
            InitializeComponent();
          panel2.Size = panel2.BackgroundImage.Size;
       //   panel2.Focus();

        //    panel2.AutoScroll = true;
      // panel3.MouseWheel += OnMouseWheel;
            drawingNodes = new List<DrawingNode>();
            shortestPath = new List<INode>();


            nodeBrush = new SolidBrush(Color.Black);
            busBrush = new SolidBrush(Color.BlueViolet);
            restBrush = new SolidBrush(Color.DarkOrange);
            edgeBrush = new SolidBrush(Color.SlateGray);
            disabledBrush = new SolidBrush(Color.Red);
            shortestBrush = new SolidBrush(Color.DarkBlue);
            
            NodeTypeCombo.SelectedIndex = 0;
            created = null;
            g = new Graph();
            begining = true;
            beginingPath = true;
            dijkstra = new DijkstraAlgorithm(g);
            zoomstep = 1;
            toolStripLabel1.Text = zoomstep*100 + " %";
        }
/*
        private void panel2_MouseWheel(object sender, MouseEventArgs e)
        {
            MessageBox.Show("It Works !");
            panel2.Size = new Size(panel2.Width*e.Delta, panel2.Height*e.Delta);
            panel2.Invalidate();
        }*/
        protected override void OnMouseWheel(MouseEventArgs e)
        {
            /*Handle the mouse wheel here*/
         // panel2.Size = new Size(Convert.ToInt32(panel2.Width + panel2.Width/10*e.Delta), Convert.ToInt32(panel2.Height +panel2.Height/10*e.Delta));
         //   panel2.Width = panel2.Width + (panel2.Width/10);
         //   panel2.Height = panel2.Height + (panel2.Height / 10);

            if (e.Delta > 0)
            {
                panel2.Width = panel2.Width + (panel2.Width / 10);
                panel2.Height = panel2.Height + (panel2.Height / 10);
                zoomstep += 0.1;
                toolStripLabel1.Text = zoomstep*100 + " %";
                //     panel2.Size = new Size(Convert.ToInt32(panel2.Width + 10 * e.Delta), Convert.ToInt32(panel2.Height + 10 * e.Delta));
                //   panel2.Size = new Size(panel2.Width+10,panel2.Height+10);
            }
            else
            {
                panel2.Width = panel2.Width - (panel2.Width / 10);
                panel2.Height = panel2.Height - (panel2.Height / 10);
                zoomstep -= 0.1;
                toolStripLabel1.Text = zoomstep * 100 + " %";
            }
            panel2.Invalidate();
        }

        private void panel2_Paint(object sender, PaintEventArgs e)
        {
             Graphics gx = e.Graphics;

            if (drawingNodes.Count == 0)
            {
                return;
            }
           

            #region DRAW NODES

            foreach (DrawingNode dn in drawingNodes)
            {
                if (dn.nodeID.Contains("K"))
                {
                    gx.FillEllipse(nodeBrush, Convert.ToInt32((dn.drawLocation.X - 4) /dn.zoomed * zoomstep), Convert.ToInt32((dn.drawLocation.Y - 4) /dn.zoomed* zoomstep ), Convert.ToInt32(8 * zoomstep), Convert.ToInt32(8 * zoomstep));
                    gx.DrawString(dn.nodeID, new Font(FontFamily.GenericSansSerif, 6), nodeBrush, Convert.ToInt32((dn.drawLocation.X + 10) /dn.zoomed*zoomstep),
                                  Convert.ToInt32((dn.drawLocation.Y - 10)/ dn.zoomed *zoomstep));


                }
                else if (dn.nodeID.Contains("Z"))
                {
                    gx.FillEllipse(busBrush, Convert.ToInt32((dn.drawLocation.X - 4) / dn.zoomed * zoomstep), Convert.ToInt32((dn.drawLocation.Y - 4) / dn.zoomed * zoomstep ), Convert.ToInt32(8 * zoomstep), Convert.ToInt32(8 * zoomstep));
                    gx.DrawString(dn.nodeID, new Font(FontFamily.GenericSansSerif, 6), busBrush, Convert.ToInt32((dn.drawLocation.X + 10) /dn.zoomed * zoomstep),
                                 Convert.ToInt32((dn.drawLocation.Y - 10) /dn.zoomed * zoomstep));


                }
                else
                {
                    gx.FillEllipse(restBrush,  Convert.ToInt32((dn.drawLocation.X - 4) / dn.zoomed * zoomstep), Convert.ToInt32((dn.drawLocation.Y - 4) / dn.zoomed * zoomstep ), Convert.ToInt32(8 * zoomstep), Convert.ToInt32(8 * zoomstep));
                    gx.DrawString(dn.nodeID, new Font(FontFamily.GenericSansSerif, 6), restBrush, Convert.ToInt32((dn.drawLocation.X + 10) / dn.zoomed* zoomstep),
                                Convert.ToInt32((dn.drawLocation.Y - 10) / dn.zoomed * zoomstep));


                }
            }

            #endregion

            #region DRAW EDGES

            INode n = null;
            string key;
            double dist;
            foreach (DrawingNode dn in drawingNodes)
            {
                n = g.FindNode(dn.nodeID);
                foreach (Follower f in n.GetFollowers())
                {
                    bool enabled = f.GetFollowingNode(out key, out dist);
                    INode dest = g.FindNode(key);

                    if (enabled)
                    {
                        gx.DrawLine(new Pen(edgeBrush, 2), Convert.ToInt32(n.GetLocation().X * zoomstep), Convert.ToInt32(n.GetLocation().Y * zoomstep), Convert.ToInt32(dest.GetLocation().X*zoomstep), Convert.ToInt32(dest.GetLocation().Y*zoomstep));

                    }
                    else
                    {
                        gx.DrawLine(new Pen(disabledBrush, 3), Convert.ToInt32(n.GetLocation().X * zoomstep), Convert.ToInt32(n.GetLocation().Y * zoomstep), Convert.ToInt32(dest.GetLocation().X * zoomstep), Convert.ToInt32(dest.GetLocation().Y * zoomstep));

                    }/*
                    Point distanceLocation;
                    if (dest.GetLocation().X > n.GetLocation().X)
                    {
                         distanceLocation =
                            new Point(
                                n.GetLocation().X +
                                Convert.ToInt32(Math.Abs(dest.GetLocation().X - n.GetLocation().X)/2) + 10,
                                n.GetLocation().Y +
                                Convert.ToInt32(Math.Abs(dest.GetLocation().Y - n.GetLocation().Y)/2));

                    }
                    else
                    {
                         distanceLocation =
                            new Point(
                                dest.GetLocation().X +
                                Convert.ToInt32(Math.Abs(dest.GetLocation().X - n.GetLocation().X) / 2) + 10,
                                dest.GetLocation().Y +
                                Convert.ToInt32(Math.Abs(dest.GetLocation().Y - n.GetLocation().Y) / 2));
                    }
                       gx.DrawString(Convert.ToString(Math.Round(dist,2)),new Font(FontFamily.GenericSansSerif,5),edgeBrush,distanceLocation.X,distanceLocation.Y );
                    */
                }
            }
            #endregion

            if (drawShortestPath)
            {
           #region DRAW SHORTEST PATH
                /// 
                /// 
                /// 
                for(int i = 0; i < shortestPath.Count-1; i++ ) 
                {
                    gx.DrawLine(new Pen(shortestBrush, 3), Convert.ToInt32(shortestPath[i].GetLocation().X * zoomstep), Convert.ToInt32(shortestPath[i].GetLocation().Y*zoomstep), Convert.ToInt32(shortestPath[i + 1].GetLocation().X*zoomstep), Convert.ToInt32(shortestPath[i + 1].GetLocation().Y*zoomstep));
                }
           #endregion
            }

            if (nearestNode != null)
            {
                #region DRAW NEAREST POINT

                foreach (DrawingNode dn in drawingNodes)
                {
                    if (dn.nodeID == nearestNode.GetId())
                    {
                        gx.FillEllipse(disabledBrush, dn.drawLocation.X - 4, dn.drawLocation.Y - 4, 8, 8);

                    }
                }

                #endregion

            }
            
        }

        private void panel2_MouseMove(object sender, MouseEventArgs e)
        {
            //panel2.Focus();
            /*string key = FindNearestNode(e.Location);
            if (String.IsNullOrEmpty(key))
            {
                return;
            }
            nearestNode = g.FindNode(key);*/
            //  panel2.Invalidate();
        }
      
        private void panel2_MouseClick(object sender, MouseEventArgs e)
        {

            if (!ShortestPathButton.Checked)
            {
                if (InsertNodeButton.Checked) // vkladame vrcholy
            
                    if(e.Button == MouseButtons.Left){
                    #region INSERT NODE

                {
                    if (NodeTypeCombo.SelectedIndex == 0)
                    {
                        created = new Node(NodeType.Crossroads, new Point(e.Location.X, e.Location.Y));
                    }
                    else if (NodeTypeCombo.SelectedIndex == 1)
                    {
                        created = new Node(NodeType.RestingPlace, e.Location);
                    }
                    else
                    {
                        created = new Node(NodeType.BusStop, e.Location);
                    }

                    g.AddNewNode(created);
                    string id = created.GetId();
                    drawingNodes.Add(new DrawingNode(e.Location, id,zoomstep));

                    // InsertNode();
                    panel2.Invalidate();
                    return;
                }

                #endregion

                    }else if (e.Button == MouseButtons.Right)
                    #region REMOVE NODE
                    {
                        if (drawingNodes.Count != 0)
                        {
                            g.RemoveNode(FindNearestNode(e.Location));
                            DrawingNode removing = null;
                            foreach (DrawingNode dn in drawingNodes)
                            {
                                if (FindNearestNode(e.Location).Equals(dn.nodeID))
                                {
                                    removing = dn;
                                }
                            }
                            drawingNodes.Remove(removing);
                            panel2.Invalidate();
                        }
                        else
                        {
                            MessageBox.Show("V grafu nejsou žádné vrcholy k odebrání", "Nelze odebrat vrchol");
                        }
                    } 
                    #endregion

                if (InsertEdgeButton.Checked) // vytvarime hrany
                
                    #region INSERT EDGE

                {

                    if (drawingNodes.Count == 0)
                    {
                        return;
                    }
                    string nearestkey = FindNearestNode(e.Location);
                    {
                        // je u bodu

                        if (begining) // nastavujeme pocatecni bod
                        {

                            to = null;
                            from = g.FindNode(nearestkey); // oznacit jako pocatek
                            begining = false;

                        }
                        else //nastavujeme koncovy bod
                        {
                            to = g.FindNode(nearestkey); // oznacit jako konec
                            begining = true;

                        }
                        if (to != null)
                        {
                            if (e.Button == MouseButtons.Left)
                            {
                                try
                                {
                                    g.AddNewEdge(from, to);
                                }
                                catch (LoopEdgeException exx)
                                {
                                    MessageBox.Show(
                                        "Smyčková hrana nemůže být vložena ( počáteční vrchol se shoduje s koncovým)",
                                        "Nelze vložit smyčkovou hranu");
                                }
                            }
                            else if (e.Button == MouseButtons.Right)
                            {
                                foreach (Follower f in from.GetFollowers())
                                {
                                    if (f.GetReferencedKey() == to.GetId())
                                    {
                                        f.DisableEdge();
                                    }
                                }
                                foreach (Follower f in to.GetFollowers())
                                {
                                    if (f.GetReferencedKey() == from.GetId())
                                    {
                                        f.DisableEdge();

                                    }
                                }
                            }
                        }

                    }
                   
                    
                    panel2.Invalidate();
                    return;
                }

                #endregion}
            }
            else
            {
                    #region SHORTEST PATH
                if (drawingNodes.Count == 0 || drawingNodes.Count == 1)
                {
                    MessageBox.Show("Nedostatek vrcholů pro výpočet cesty","Chyba hledání cesty");
                    return;
                }
                if (e.Button == MouseButtons.Right)
                {
                    pathBegin = null;
                    pathEnd = null;
                    beginingPath = true;
                    ShortestPathButton.Checked = false;
                    
                    return;
                }
                if (beginingPath)
                {
                    string key = FindNearestNode(e.Location);
                    pathBegin = g.FindNode(key);
                    beginingPath = false;
                }
                else  
                {
                    string key2 = FindNearestNode(e.Location);
                    pathEnd = g.FindNode(key2);
               
                    shortestPath = dijkstra.Execute(pathBegin, pathEnd);
                    drawShortestPath = true;
                    panel2.Invalidate();
                 
                } 

                #endregion
            }
           
        }



        private void InsertEdgeButton_CheckedChanged(object sender, EventArgs e)
        {
            if (InsertEdgeButton.Checked)
            {
                InsertNodeButton.Checked = false;
            }
            else
            {
                InsertNodeButton.Checked = true;
            }
        }

        private void InsertNodeButton_CheckedChanged(object sender, EventArgs e)
        {
            if (InsertNodeButton.Checked)
            {
                InsertEdgeButton.Checked = false;
            }
            else
            {
                InsertEdgeButton.Checked = true;
            }
        }

        private void ShortestPathButton_CheckedChanged(object sender, EventArgs e)
        {
            if (!ShortestPathButton.Checked)
            {
                shortestPath = new List<INode>();
                drawShortestPath = false;
                panel2.Invalidate();
            }
        }

      private string FindNearestNode(Point e)
      {
          double dist = double.PositiveInfinity;
          string key = null;
          foreach (DrawingNode dn in drawingNodes)
          {
              double calcdist = Math.Sqrt(Math.Pow(dn.drawLocation.X/dn.zoomed*zoomstep - e.X*zoomstep, 2) + Math.Pow(dn.drawLocation.Y/dn.zoomed*zoomstep - e.Y*zoomstep, 2));
              if (calcdist < dist)
              {
                  key = dn.nodeID;
                  dist = calcdist;
              }
          }
          return key;
      }

      private void panel2_MouseDown(object sender, MouseEventArgs e)
      {
         
      }
       

        private void NodeTypeCombo_MouseLeave(object sender, EventArgs e)
        {
            Focus();
        }

        private void NodeTypeCombo_SelectedIndexChanged(object sender, EventArgs e)
        {
            SendKeys.SendWait("{ESC}"); //hack na ztratu focusu
           

        }

       

      
      

      
    }

    internal class DrawingNode
    {
        public Point drawLocation;
        public double zoomed;
        public string nodeID;

        public DrawingNode(Point loc, string nodeID,double zoomed)
        {
            drawLocation = loc;
            this.nodeID = nodeID;
            this.zoomed = zoomed;
        }
    }
}
